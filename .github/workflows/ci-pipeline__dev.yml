name: CI Pipeline - DEV
on:
  workflow_dispatch:
  push:
    branches:
      - dev

env:
  GIT__BRANCH      : 'dev'
  RELEASE_TYPE     : 'minor'
  PACKAGE_NAME     : 'mgraph_ai_service_base'
  TARGET_DEPLOY    : 'dev'

jobs:

  run-tests:
    name: "Run tests"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Start Local Stack
        uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/docker__local-stack@dev
        with:
          LOCAL_STACK_SERVICES: 's3,lambda,iam,logs'

      - name: "run-tests"
        uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/pytest__run-tests@dev
        with:
          test_target: "tests/unit"
        env:
          FAST_API__AUTH__API_KEY__NAME  : 'api-key__in_github_test'
          FAST_API__AUTH__API_KEY__VALUE : 'this-is-the-value-of-the-api-key'

  increment-tag:
    name: Increment Tag - DEV
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Increment Tag
        uses: owasp-sbot/OSBot-GitHub-Actions/.github/actions/git__increment-tag@dev
        with:
          release_type: ${{ env.RELEASE_TYPE }}
    needs:
      - run-tests

  check-aws-credentials:
    name: Check AWS Credentials
    runs-on: ubuntu-latest
    outputs:
      has-credentials: ${{ steps.check.outputs.has-credentials }}
    steps:
      - uses: actions/checkout@v4

      - name: Check if AWS credentials are configured
        id: check
        run: |
          if [[ -n "${{ secrets.AWS_ACCESS_KEY_ID }}" ]] && \
             [[ -n "${{ secrets.AWS_SECRET_ACCESS_KEY }}" ]] && \
             [[ -n "${{ secrets.AWS_DEFAULT_REGION }}" ]] && \
             [[ -n "${{ secrets.AWS_ACCOUNT_ID }}" ]]; then
            echo "has-credentials=true" >> $GITHUB_OUTPUT
            echo "✅ AWS credentials are configured"
          else
            echo "has-credentials=false" >> $GITHUB_OUTPUT
            echo "⚠️  AWS credentials are not configured - deployment will be skipped"
          fi
    needs:
      - run-tests

  aws_deploy_lambda:
    if     : needs.check-aws-credentials.outputs.has-credentials == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Deploy Service Lambda function
        uses: ./.github/actions/aws__deploy__lambda
        env:
          AWS_SECRET_ACCESS_KEY          : ${{ secrets.AWS_SECRET_ACCESS_KEY          }}
          AWS_DEFAULT_REGION             : ${{ secrets.AWS_DEFAULT_REGION             }}
          AWS_ACCOUNT_ID                 : ${{ secrets.AWS_ACCOUNT_ID                 }}
          AWS_ACCESS_KEY_ID              : ${{ secrets.AWS_ACCESS_KEY_ID              }}
          FAST_API__AUTH__API_KEY__NAME  : ${{ secrets.FAST_API__AUTH__API_KEY__NAME  }}
          FAST_API__AUTH__API_KEY__VALUE : ${{ secrets.FAST_API__AUTH__API_KEY__VALUE }}
        with:
          target  : ${{ env.TARGET_DEPLOY }}

    needs:
      - check-aws-credentials
      - increment-tag